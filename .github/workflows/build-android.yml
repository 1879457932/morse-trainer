name: Build Android APP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install buildozer
          pip install cython==0.29.33
          sudo apt update
          sudo apt install -y git zip unzip openjdk-11-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
          sudo apt install -y libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev
          sudo apt install -y x11proto-core-dev libx11-dev libxrandr-dev
          sudo apt install -y libzbar-dev
          sudo apt install -y libxext-dev
          sudo apt install -y libjpeg-dev libatlas-base-dev

      - name: Build with Buildozer
        run: |
          # 确保图标和启动画面已创建
          echo "尝试创建图标和启动画面..."
          if python create_icons.py; then
            echo "图标创建成功或已经存在"
          else
            echo "警告：图标创建失败，但将继续使用现有图标"
            # 安装PIL库用于图标创建
            pip install pillow
          fi
          
          # 设置buildozer参数
          export BUILDOZER_BUILD_MODE=debug
          export BUILDOZER_VERBOSE=2  # 提高日志级别
          # 确保使用正确的minapi值
          export ANDROIDMINAPI=24
          export ANDROIDAPI=31
          export PATH=$PATH:~/.local/bin
          
          # 创建所需的基本目录
          mkdir -p .buildozer/hooks
          mkdir -p .buildozer/android/platform
          
          # 拷贝hooks和配置，确保构建过程中不会被删除
          cp -f .buildozer/hooks/before.sh .buildozer_before.sh || true
          
          # 确保NDK指向正确位置
          echo "确认NDK路径..."
          export ANDROIDNDK=~/.buildozer/android/platform/android-ndk-r25b
          
          # 配置Python下载URL修复
          echo "修改Python下载URL..."
          # 使用Python 3.9.14 - 最新稳定URL
          sed -i 's|https://www.python.org/ftp/python/3.9/Python-3.9.tgz|https://www.python.org/ftp/python/3.9.14/Python-3.9.14.tgz|g' .buildozer/android/platform/python-for-android/pythonforandroid/recipes/python3/__init__.py || true
          
          # 使用直接命令构建
          echo "开始构建APK，使用直接命令..."
          PYTHONPATH=$PYTHONPATH:. buildozer android debug || true
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: bin/*.apk

      - name: List generated files
        run: |
          find bin -type f || true
          find .buildozer -name "*.apk" || true
          find .buildozer -name "*.log" || true
          find . -name "buildozer.log" || true
      
      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: .buildozer/logs 